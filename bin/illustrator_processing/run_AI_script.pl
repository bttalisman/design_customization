# Pass the name of a configuration file as the first argument.  This json object contains
# "source file", "script file", "output folder" keys and values.

# An AppleScript script is built using this information.  Adobe Illustrator is
# run, opening the source file.  Adobe Illustrator is told to load and run the
# script file passed as a config value.  Any output generated by AI is always placed
# in the /output/ subfolder.  This script then moves all files in the /output/ subfolder to the
# output folder specified as a config value.


use Modern::Perl;
use JSON::XS;

my $ASCode = <<EOD;
    on run
    		tell application "Adobe Illustrator"
    			activate

          open "<<source>>"
    			try
    				close windows
    			end try

    			open "<<script>>"
    			try
    				close windows
    			end try

    			close current document

    		end tell
    end run
EOD

my $config_file=$ARGV[0];

my $json_text = do {
   open(my $json_fh, "<:encoding(UTF-8)", $config_file)
      or die("Can't open \$config_file\": $!\n");
   local $/;
   <$json_fh>
};

my $perl_hash  = decode_json $json_text;


my $SourceFile = $perl_hash->{ "source file" };
my $ScriptFile = $perl_hash->{ "script file" };
my $outputFolder = $perl_hash->{ "output folder" };

$ASCode =~ s/<<source>>/$SourceFile/g;
$ASCode =~ s/<<script>>/$ScriptFile/g;


sub osascript($) {

  system 'osascript', map { ('-e', $_) } split(/\n/, $_[0]);

}


osascript $ASCode;
