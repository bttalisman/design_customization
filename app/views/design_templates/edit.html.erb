

<form action='update' id='design_template_form'>

  <div class='row'>
    <div class='col col-md-1'></div>
    <div class='col col-md-4'>

      <div class="panel panel-default">
        <div class="panel-heading">
          <h3 class="panel-title">Edit Template</h3>
        </div>
        <div class="panel-body">

          <div class='input-group' style='margin-bottom:20px;'>
            <span class="input-group-addon" id="basic-addon1">Name</span>
            <input type='text' class='form-control' id='design_template_name' aria-describedby="basic-addon1" value='<%= @design_template.name %>'></input>
          </div>

          <a class='btn btn-default' href='<%= local_host %>/force_process?id=<%= @design_template.id %>'>Reprocess</a>
          <a class='btn btn-default' onclick='update_template( <%= @design_template.id %> ); return false;'>Update</a>
          <a class='btn btn-default' href='<%= local_host %>/design_templates/<%= @design_template.id %>'>Cancel</a>
          <a class="btn btn-default" href="/design_templates/<%= @design_template.id %>" data-confirm="Are you sure?" data-method="delete" rel="nofollow">Delete</a>

        </div> <!-- /panel body -->
      </div> <!-- /panel -->

    </div> <!--  -->

    <div class='col-md-1'></div>

    <div class='col-md-5'>
      <div id='panel_container'></div>
    </div>

  </div> <!-- /row -->

  <input name='panel_data' id='tags_data' style='display:none;'></input>

</form>



<script>


  function validate()
  {
    var dtName = $('#design_template_name').val();

    if( (dtName === null) || (dtName === '') )
    {
      alert( 'Please enter a name for this template.' );
      return false;
    }

    return validate_design_template_settings();
  }



  // This function is called when the user clicks save.  Data from the form
  // is gathered and posted to the design_template controller.
  function update_template( templateId )
  {
    if( validate() )
    {
      var extractedSettings = build_template_settings();
      var oToSend = {};

      // We stuff our own data in there too
      var oGeneralSettings = {};
      oGeneralSettings.template_name = $('#design_template_name').val();

      // the number and type of these settings depends on what was extracted from the original file
      oToSend.extracted_settings = extractedSettings;
      // these are always the same
      oToSend.general_settings = oGeneralSettings;

      var uri = '<%= local_host %>' + '/design_templates/' + templateId + '/settings/';

      $.ajax({
          url: uri,
          type: 'post',
          dataType: 'application/json',
          data: JSON.stringify( oToSend ),
          success: function (data) {
              alert( 'success getting : ' + data );
          },
          error: function(xhr, status, error) {
              // todo - why never success?
          }
      });

      window.location = '<%= local_host %>';
    }
  }


  // This function goes and gets the html, generated by the partials controller, that
  // is based on what was extracted from the original file
  function getTemplateHTML( templateId )
  {
    var o;
    var uri;

    // If both of these arrays have no elements, then either the file contained
    // nothing to extract, or there is no file.
<%  if @images.empty? && @tags.empty? %>
      $('#panel_container').html( '<b>This Illustrator file is not a template.</b>' );
      return;
<%  end %>

    uri = '<%= local_host %>' + '/partials/extracted_settings/' + templateId;

    $.get( uri, function(data, status)
    {
      $('#panel_container').html( data );
    });
  }


  $(document).ready(function() {
    getTemplateHTML( <%= @design_template.id %> );
  } );


</script>
